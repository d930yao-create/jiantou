<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="å°–é ­æ²¹é£¯ - å‚³çµ±ç¾å‘³é»é¤ç³»çµ±">
    <meta name="theme-color" content="#FDFBF7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>å°–é ­æ²¹é£¯ | é»é¤</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/d930yao-create/jiantou/refs/heads/main/image/download-Photoroom.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/d930yao-create/jiantou/refs/heads/main/image/download-Photoroom.png">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        :root {
            --color-cream: #FDFBF7;
            --color-brick: #9E5A5A;
            --color-brick-dark: #7F4545;
            --color-stone: #44403C;
            --color-stone-light: #78716C;
            --color-stone-muted: #A8A29E;
            --color-paid-bg: #FDE68A;
            --color-paid-text: #92400E;
            --color-done-bg: #D1FAE5;
            --color-done-text: #065F46;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--color-cream); 
            font-weight: 500; 
            color: var(--color-stone);
        }

        .serif { font-family: 'Noto Serif TC', serif; }
        .text-brick { color: var(--color-brick); }
        .bg-brick { background-color: var(--color-brick); }
        .status-paid { background-color: var(--color-paid-bg); color: var(--color-paid-text); }
        .status-done { background-color: var(--color-done-bg); color: var(--color-done-text); }
        
        [v-cloak] { display: none !important; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden select-none">

<div id="app" v-cloak class="h-full flex flex-col relative">
    
    <audio id="pickupSound" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" preload="auto"></audio>

    <main v-if="!hasEnteredShop" class="flex-1 w-full bg-[#FDFBF7] overflow-y-auto" role="main">
        <div class="min-h-full flex flex-col items-center justify-center py-12 px-4">
            <header class="w-full max-w-xs flex flex-col items-center">
                <div class="w-24 h-24 flex items-center justify-center mx-auto mb-2 animate-[fadeIn_0.5s_ease-out]">
                    <img src="https://github.com/d930yao-create/jiantou/blob/main/image/jt2.png?raw=true" alt="å°–é ­æ²¹é£¯ Logo" class="w-full h-full object-contain">
                </div>
                <h1 class="text-4xl font-bold text-stone-800 tracking-wide serif mb-2 animate-[fadeIn_0.5s_ease-out]">å°–é ­æ²¹é£¯</h1>
                <p class="text-sm text-brick tracking-[0.3em] font-bold animate-[fadeIn_0.5s_ease-out]">TRADITIONAL TASTE</p>
                
                <div class="mt-4 mb-8 animate-[fadeIn_0.5s_ease-out]">
                    <span v-if="shopIsOpen" class="bg-green-100 text-green-700 px-4 py-1.5 rounded-full text-sm font-bold border border-green-200">â— ç‡Ÿæ¥­ä¸­</span>
                    <span v-else class="bg-stone-200 text-stone-500 px-4 py-1.5 rounded-full text-sm font-bold border border-stone-300">â— ä¼‘æ¯ä¸­</span>
                </div>

                <div class="w-full space-y-4 animate-[slideUp_0.5s_ease-out]">
                    <button @click="enterShop" 
                        :disabled="!shopIsOpen && !myOrder"
                        class="w-full py-5 rounded-2xl font-bold text-xl shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95"
                        :class="(!shopIsOpen && !myOrder) ? 'bg-stone-200 text-stone-400 cursor-not-allowed' : 'bg-brick text-white hover:bg-red-900 shadow-red-100'"
                        aria-label="é–‹å§‹é»é¤æˆ–æŸ¥çœ‹è¨‚å–®">
                        <span class="material-icons-round text-2xl" aria-hidden="true">{{ myOrder ? 'receipt_long' : 'flatware' }}</span>
                        {{ myOrder ? 'æŸ¥çœ‹æˆ‘çš„è¨‚å–®' : (shopIsOpen ? 'é–‹å§‹é»é¤' : 'æš«åœé»é¤') }}
                    </button>

                    <button @click="isTrackingMode=true" 
                        class="w-full py-5 bg-white border-2 border-stone-100 text-stone-600 rounded-2xl font-bold text-xl shadow-sm flex items-center justify-center gap-2 active:scale-95 transition-transform hover:bg-stone-50 hover:border-stone-200"
                        aria-label="å–®è™Ÿè¿½è¹¤">
                        <span class="material-icons-round text-2xl text-yellow-500" aria-hidden="true">search</span>
                        å–®è™Ÿè¿½è¹¤
                    </button>
                </div>
            </header>

            <section class="mt-16 text-center animate-[slideUp_0.5s_ease-out]">
                <p class="text-sm text-stone-400 mb-1 tracking-[0.2em] uppercase">ç¾åœ¨å«è™Ÿ</p>
                <p class="text-7xl font-bold text-stone-300 serif">#{{ currentCallingNumber || '--' }}</p>
            </section>
        </div>
    </main>

    <main v-else class="flex-1 flex flex-col h-full overflow-hidden animate-[fadeIn_0.3s_ease-out]" role="main">
        <header class="px-6 pt-8 pb-4 bg-[#FDFBF7] z-10 flex-shrink-0 flex justify-between items-center">
            <div @click="hasEnteredShop=false" class="cursor-pointer" role="button" aria-label="è¿”å›é¦–é ">
                <h1 class="text-2xl font-bold text-stone-800 tracking-wide serif flex items-center gap-1">
                    <span class="material-icons-round text-stone-400 text-2xl" aria-hidden="true">arrow_back_ios</span>
                    å°–é ­æ²¹é£¯
                </h1> 
                <p class="text-xs text-brick mt-1 tracking-widest pl-7">TRADITIONAL TASTE</p>
            </div>
        </header>

        <section class="flex-1 overflow-y-auto px-5 pb-64 space-y-4">
            <article v-for="item in menu" :key="item.id" class="flex justify-between items-start bg-white p-5 rounded-2xl shadow-sm border border-stone-100">
                <div class="flex-1 pr-2">
                    <h3 class="text-xl font-bold text-stone-800 serif leading-tight">{{ item.name }}</h3>
                    <p class="text-sm text-stone-400 mt-2">{{ item.desc }}</p>
                    <span class="text-brick font-bold mt-3 block text-xl">${{ item.price }}</span>
                </div>
                <nav class="flex items-center gap-3 ml-2 self-end mb-1">
                    <button v-if="getItemCount(item.id) > 0" @click="removeFromCart(item)" 
                        class="w-10 h-10 rounded-full border-2 border-stone-200 text-stone-400 flex items-center justify-center text-xl font-bold active:bg-stone-100 transition-colors"
                        aria-label="æ¸›å°‘æ•¸é‡">-</button>
                    <span v-if="getItemCount(item.id) > 0" class="font-bold text-stone-800 w-6 text-center text-lg">{{ getItemCount(item.id) }}</span>
                    <button @click="addToCart(item)" 
                        class="w-10 h-10 rounded-full bg-brick text-white flex items-center justify-center shadow-lg shadow-red-100 text-xl font-bold active:scale-95 transition-transform" 
                        :disabled="!shopIsOpen && !myOrder && !isAppending"
                        aria-label="å¢åŠ æ•¸é‡">+</button>
                </nav>
            </article>
            <div v-if="!shopIsOpen && !myOrder && !isAppending" class="text-center py-10">
                <p class="text-stone-400 font-bold mb-2 text-lg">æœ¬åº—ä¼‘æ¯ä¸­</p>
                <p class="text-sm text-stone-300">æš«åœé»é¤ï¼Œåƒ…ä¾›æŸ¥è©¢è¨‚å–®</p>
            </div>
        </section>

<div v-if="!shopIsOpen && !myOrder && !isAppending" class="text-center py-10">
                <p class="text-stone-400 font-bold mb-2 text-lg">æœ¬åº—ä¼‘æ¯ä¸­</p>
                <p class="text-sm text-stone-300">æš«åœé»é¤ï¼Œåƒ…ä¾›æŸ¥è©¢è¨‚å–®</p>
            </div>

            <div class="pt-8 pb-4 flex items-center justify-center gap-4 border-t border-stone-100 mt-2">
                
                <a href="https://www.instagram.com/jiantou_?igsh=NDN3NHlpbzVxbGg4" target="_blank" class="flex items-center gap-2 px-5 py-2.5 bg-white border border-stone-200 rounded-full text-stone-400 active:scale-95 transition-transform hover:bg-stone-50 hover:text-brick">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <rect x="2" y="2" width="20" height="20" rx="5" stroke-width="2"></rect>
                        <path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z" stroke-width="2"></path>
                        <line x1="17.5" y1="6.5" x2="17.51" y2="6.5" stroke-width="2" stroke-linecap="round"></line>
                    </svg>
                    <span class="text-xs font-bold tracking-wider uppercase">Instagram</span>
                </a>

                <a href="https://lin.ee/xfFqC97" target="_blank" class="flex items-center gap-2 px-5 py-2.5 bg-white border border-stone-200 rounded-full text-stone-400 active:scale-95 transition-transform hover:bg-stone-50 hover:text-green-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <span class="text-xs font-bold tracking-wider uppercase">LINE</span>
                </a>

            </div>
        </section> <footer class="fixed bottom-0 left-0 right-0 z-20 safe-area-bottom" role="contentinfo">
        

        <footer class="fixed bottom-0 left-0 right-0 z-20 safe-area-bottom" role="contentinfo">
            <section v-if="(!myOrder && !trackedNumber) || isAppending" class="bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.05)] rounded-t-3xl p-6">
                <div class="flex justify-between items-center mb-5">
                    <div>
                        <p class="text-sm text-stone-400 mb-1">{{ isAppending ? 'åŠ é»ç¸½é‡‘é¡' : 'ç¸½é‡‘é¡' }}</p>
                        <p class="text-4xl font-bold text-stone-800 serif">${{ cartTotal }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-stone-400 mb-1">{{ isAppending ? 'æ–°å¢å“é …' : 'å·²é¸å“é …' }}</p>
                        <p class="text-lg font-bold text-stone-800">{{ cartCount }} ä»½</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button v-if="isAppending" @click="isAppending=false; cart={}" class="px-6 py-4 rounded-xl font-bold text-lg text-stone-500 bg-stone-100 transition-all active:scale-95">å–æ¶ˆ</button>
                    <button @click="openConfirmation" :disabled="cartCount===0" class="flex-1 py-4 rounded-xl font-bold text-xl tracking-wide text-white shadow-lg bg-brick disabled:opacity-50 transition-all active:scale-95">{{ isAppending ? 'ç¢ºèªåŠ é»æ˜ç´°' : 'é»é¤æ˜ç´°' }}</button>
                </div>
            </section>

            <section v-else-if="!isAppending" class="bg-white border-t border-brick shadow-[0_-10px_40px_rgba(0,0,0,0.1)] p-6 pb-8 max-h-[70vh] overflow-y-auto">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-sm text-stone-400 uppercase tracking-widest mb-1">YOUR NUMBER</p>
                        <h2 class="text-6xl font-bold text-stone-800 serif">#{{ myOrder?.number || trackedNumber }}</h2>
                    </div>
                    <div class="text-right">
                        <span v-if="trackedNumber" class="px-4 py-2 rounded-full text-sm font-bold" :class="isTrackedNumberCalled ? 'status-done animate-pulse' : 'bg-gray-200 text-gray-600'">{{ isTrackedNumberCalled ? 'å¯å–é¤' : 'ç­‰å¾…å«è™Ÿ' }}</span>
                        <span v-else class="px-4 py-2 rounded-full text-sm font-bold" :class="{'bg-gray-200 text-gray-600': myOrder.status==='pending', 'status-paid': myOrder.status==='paid', 'status-done': myOrder.status==='done'}">{{ getStatusText(myOrder.status) }}</span>
                    </div>
                </div>

                <div v-if="myOrder" class="bg-stone-50 rounded-xl p-5 mb-4 border border-stone-100">
                    <div class="flex justify-between items-center mb-3 cursor-pointer" @click="showDetails = !showDetails" role="button" :aria-expanded="showDetails">
                        <span class="text-sm font-bold text-stone-500">è¨‚å–®æ˜ç´° ({{ myOrder.items.length }}é …)</span>
                        <span class="material-icons-round text-stone-400 text-lg transform transition-transform" :class="showDetails ? 'rotate-180' : ''" aria-hidden="true">expand_more</span>
                    </div>
                    <div v-if="showDetails" class="space-y-3 border-t border-stone-200 pt-3 mt-2">
                        <div v-for="(item, index) in myOrder.items" :key="index" class="flex justify-between text-base text-stone-600 border-b border-stone-100 pb-2 last:border-0">
                            <div class="flex flex-col">
                                <span class="font-bold">{{ item.name }} <span class="font-normal text-stone-400">x{{ item.qty }}</span></span>
                                <span v-if="item.options && item.options.length > 0" class="text-xs text-brick mt-1 font-bold">åŠ è³¼: {{ item.options.join(', ') }}</span>
                            </div>
                            <span class="font-bold mt-0.5">${{ item.price * item.qty }}</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold text-stone-800 pt-2 border-t border-stone-200 mt-2"><span>ç¸½è¨ˆ</span><span>${{ myOrder.total }}</span></div>
                    </div>
                </div>
                
                <div v-if="myAddonOrder && myAddonOrder.status === 'pending'" class="mb-4 p-4 bg-orange-50 rounded-xl border border-orange-100 relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-orange-100 rounded-bl-full opacity-50"></div>
                    <div class="relative z-10">
                        <p class="font-bold text-orange-700 mb-1 flex items-center gap-1">
                            <span class="material-icons-round text-sm" aria-hidden="true">notifications_active</span> åŠ é»é …ç›®å¾…çµå¸³
                        </p>
                        <p class="text-sm text-orange-600 mb-3">è«‹è‡³æ«ƒæª¯æ”¯ä»˜åŠ é»é‡‘é¡ <span class="font-bold text-brick text-base">${{ myAddonOrder.total }}</span></p>
                        <button @click="cancelAddon" class="px-4 py-2 bg-white text-orange-500 rounded-lg text-xs font-bold shadow-sm border border-orange-100 active:scale-95 transition-transform">å–æ¶ˆåŠ é»</button>
                    </div>
                </div>

                <div v-if="trackedNumber && !isTrackedNumberCalled" class="text-center p-6 bg-stone-50 rounded-xl text-stone-500 text-base mb-4">
                    <p class="font-bold mb-1">ğŸ” æ­£åœ¨è¿½è¹¤å«è™Ÿæ©Ÿ...</p>
                    <p class="text-sm mt-1">è«‹ä¿æŒç¶²é é–‹å•Ÿï¼Œå«è™Ÿæ™‚æœƒé€šçŸ¥æ‚¨</p>
                </div>

                <div v-if="myOrder?.status === 'pending'" class="text-center p-4 bg-stone-100 rounded-xl text-stone-500 text-base mb-4">
                    è«‹è‡³æ”¤ä½ç¾å ´ä»˜æ¬¾<br>
                    å®Œæˆå¾Œé–‹å§‹è£½ä½œé¤é»<br>
                    <button @click="cancelOrder" class="mt-3 text-sm text-stone-400 underline p-2" aria-label="å–æ¶ˆè¨‚å–®ä¸¦é‡æ–°é»é¤">å–æ¶ˆè¨‚å–® (é‡æ–°é»é¤)</button>
                </div>

                <aside v-if="myOrder && !isTrackedNumberCalled && myOrder.status !== 'done'" class="p-4 bg-stone-50 rounded-xl border border-stone-200 flex items-start gap-3">
                    <span class="material-icons-round text-stone-400 text-xl opacity-80 mt-0.5" aria-hidden="true">info</span>
                    <div class="text-sm text-stone-500 leading-relaxed text-left">
                        <p class="font-bold text-stone-600 mb-1 tracking-wide">å‡ºé¤å°æé†’</p>
                        <p>è˜¿è””ç³•ç‚ºç¾é»ç¾ç…ï¼Œéœ€ç¨ä½œç­‰å¾…</p>
                        <p>è‹¥è¨‚å–®å…§åƒ…æœ‰æ²¹é£¯ï¼Œæœƒå„ªå…ˆå‡ºé¤</p>
                        <p>å‡ºé¤è¨Šæ¯è‹¥æœ‰ä¸åŒé€ æˆä¸ä¾¿æ•¬è«‹è¦‹è«’ğŸ™‡ğŸ»â€â™€ï¸</p>
                    </div>
                </aside>

                <p v-if="myOrder?.status === 'done' || isTrackedNumberCalled" class="text-center text-lg font-bold text-green-600 mt-4 animate-pulse">ğŸ‰ é¤é»å¥½å›‰ï¼è«‹å–é¤</p>

                <button @click="startAppend" v-if="myOrder && myOrder.status === 'paid' && (!myAddonOrder || myAddonOrder.status !== 'pending')" 
                    class="w-full mt-4 py-3 bg-stone-100 text-stone-600 rounded-xl text-base font-bold active:scale-95 transition-transform flex items-center justify-center gap-2"
                    aria-label="æ–°å¢é¤é»åˆ°æ­¤è¨‚å–®">
                    <span class="material-icons-round text-lg" aria-hidden="true">add_circle_outline</span> æˆ‘æƒ³åŠ é»
                </button>
                
                <button @click="resetOrder" v-if="myOrder?.status==='done' || myOrder?.status==='archived' || isTrackedNumberCalled" class="w-full mt-4 py-3 border-2 border-stone-200 rounded-xl text-base font-bold text-stone-400">é—œé–‰</button>
                
                <button @click="stopTracking" v-if="trackedNumber && !isTrackedNumberCalled" class="w-full mt-4 text-sm text-stone-400 underline p-2">åœæ­¢è¿½è¹¤</button>
            </section>
        </footer>
    </main>

    <div v-if="selectedItemForOptions" class="fixed inset-0 bg-black/60 z-[70] flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm" @click.self="selectedItemForOptions=null" role="dialog" aria-modal="true">
        <section class="bg-white w-full sm:max-w-sm rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl animate-[slideUp_0.2s_ease-out]">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-2xl font-bold text-stone-800 serif">{{ selectedItemForOptions.name }}</h3>
                <button @click="selectedItemForOptions=null" class="text-stone-400 p-1" aria-label="é—œé–‰é¸é …"><span class="material-icons-round" aria-hidden="true">close</span></button>
            </div>
            <p class="text-sm text-stone-500 mb-4 border-b border-stone-100 pb-3">å®¢è£½åŒ–é¸é … / åŠ åƒ¹è³¼</p>
            
            <div class="space-y-3 mb-6 max-h-[40vh] overflow-y-auto px-1">
                <label v-for="(opt, idx) in selectedItemForOptions.options" :key="idx" class="flex items-center justify-between p-3 border border-stone-200 rounded-xl cursor-pointer active:bg-stone-50 transition-colors">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" :value="opt" v-model="selectedOptionsArr" class="w-5 h-5 accent-brick rounded">
                        <span class="font-bold text-stone-700">{{ opt.name }}</span>
                    </div>
                    <span v-if="opt.price > 0" class="text-brick font-bold">+${{ opt.price }}</span>
                    <span v-else class="text-stone-400 text-sm font-bold">å…è²»</span>
                </label>
            </div>
            
            <button @click="confirmAddOptions" class="w-full py-4 bg-brick text-white rounded-xl font-bold text-xl shadow-lg shadow-red-100 active:scale-95 transition-transform">
                åŠ å…¥è³¼ç‰©è»Š
            </button>
        </section>
    </div>

    <div v-if="showPickupModal" class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-[fadeIn_0.3s_ease-out]" role="dialog" aria-modal="true">
        <section class="bg-white w-full max-w-sm rounded-2xl p-8 text-center relative shadow-2xl border-4 border-green-400">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-[bounce_1s_infinite]">
                <span class="material-icons-round text-5xl text-green-500" aria-hidden="true">restaurant</span>
            </div>
            <h2 class="text-2xl font-bold text-stone-800 mb-2">é¤é»å¥½å›‰ï¼</h2>
            <p class="text-stone-500 mb-6 text-lg">å‘¼å«è™Ÿç¢¼</p>
            <div class="text-8xl font-bold text-brick serif mb-8">#{{ myOrder?.number || trackedNumber }}</div>
            <button @click="closePickupModal" class="w-full py-5 bg-stone-800 text-white rounded-xl font-bold text-xl shadow-lg active:scale-95 transition-transform">
                æˆ‘çŸ¥é“äº†ï¼Œé¦¬ä¸Šå»æ‹¿ï¼
            </button>
        </section>
    </div>

    <div v-if="isTrackingMode" class="fixed inset-0 bg-white z-40 flex flex-col items-center justify-center p-6 animate-[slideUp_0.3s_ease-out]" role="dialog" aria-modal="true">
        <button @click="isTrackingMode=false" class="absolute top-6 right-6 text-stone-400 p-2" aria-label="é—œé–‰è¿½è¹¤"><span class="material-icons-round text-4xl" aria-hidden="true">close</span></button>
        <h2 class="text-3xl font-bold text-stone-800 mb-2 serif">è¼¸å…¥é ˜é¤è™Ÿç¢¼</h2>
        <p class="text-stone-400 text-base mb-8">æ«ƒå°é»é¤çš„å®¢äººï¼Œè«‹è¼¸å…¥å–é¤è™Ÿç¢¼</p>
        <input type="tel" maxlength="3" v-model="tempTrackInput" @input="trackError=''" placeholder="88" 
            class="w-full text-center text-8xl font-bold text-brick border-b-4 border-stone-100 focus:border-brick outline-none py-6 mb-2 bg-transparent serif placeholder-stone-200 h-40"
            aria-label="è¼¸å…¥å–é¤è™Ÿç¢¼">
        <p v-if="trackError" class="text-brick font-bold mb-6 h-6 animate-[fadeIn_0.3s_ease-out]" role="alert">{{ trackError }}</p>
        <div v-else class="h-6 mb-6"></div>
        <button @click="startTracking" :disabled="!tempTrackInput" class="w-full max-w-xs py-5 bg-brick text-white rounded-xl font-bold text-2xl shadow-lg shadow-red-100 disabled:opacity-50 active:scale-95 transition-transform">
            é–‹å§‹è¿½è¹¤
        </button>
    </div>

    <div v-if="isConfirming" class="fixed inset-0 bg-black/60 z-40 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm" @click.self="isConfirming=false" role="dialog" aria-modal="true">
        <section class="bg-white w-full sm:max-w-sm rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl animate-[slideUp_0.3s_ease-out]">
            <h3 class="text-2xl font-bold text-stone-800 mb-4 serif text-center border-b border-stone-100 pb-4">{{ isAppending ? 'ç¢ºèªåŠ é»å…§å®¹' : 'ç¢ºèªé¤é»å…§å®¹' }}</h3>
            <div class="space-y-4 max-h-[40vh] overflow-y-auto mb-6 px-1">
                <article v-for="(cItem, cartKey) in cart" :key="cartKey" class="flex justify-between items-start text-base border-b border-stone-100 pb-3 last:border-0">
                    <div class="flex flex-col flex-1 pr-4">
                        <span class="font-bold text-stone-700 text-lg leading-tight">{{ cItem.item.name }}</span>
                        <span v-if="cItem.options.length > 0" class="text-xs text-brick mt-1 font-bold">
                            åŠ è³¼: {{ cItem.options.map(o => o.name).join(', ') }}
                        </span>
                        <span v-else class="text-xs text-stone-400 mt-1">{{ cItem.item.desc }}</span>
                    </div>
                    <div class="flex items-center gap-3 mt-1">
                        <span class="text-stone-500 font-bold">x{{ cItem.qty }}</span>
                        <span class="font-bold w-16 text-right text-lg">${{ (cItem.item.price + cItem.options.reduce((s,o)=>s+o.price,0)) * cItem.qty }}</span>
                    </div>
                </article>
            </div>
            <div class="flex justify-between items-center border-t border-dashed border-stone-300 pt-4 mb-4">
                <span class="text-stone-500 font-bold text-lg">{{ isAppending ? 'åŠ é»ç¸½è¨ˆ' : 'ç¸½è¨ˆé‡‘é¡' }}</span>
                <span class="text-4xl font-bold text-brick serif">${{ cartTotal }}</span>
            </div>
            
            <div v-if="!isAppending" class="mb-6 p-4 bg-stone-50 rounded-xl border border-stone-100">
                <label class="block text-sm font-bold text-stone-600 mb-2 text-center">è«‹è¼¸å…¥æ‰‹æ©Ÿæœ«ä¸‰ç¢¼ å–é¤ç”¨</label>
                <input type="tel" maxlength="3" v-model="phoneSuffix" placeholder="é»æ“Šè¼¸å…¥" 
                    class="w-full bg-white border border-stone-200 rounded-lg p-3 text-center text-xl font-bold outline-none focus:border-brick tracking-widest text-brick"
                    aria-label="æ‰‹æ©Ÿæœ«ä¸‰ç¢¼">
            </div>

            <nav class="flex gap-3 mt-2">
                <button @click="isConfirming=false" class="flex-1 py-4 bg-stone-100 text-stone-500 rounded-xl font-bold text-lg">è¿”å›ä¿®æ”¹</button>
                <button @click="submitOrder" :disabled="isSubmitting" 
                    class="flex-1 py-4 bg-brick text-white rounded-xl font-bold text-lg shadow-lg shadow-red-100 disabled:opacity-50">
                    {{ isSubmitting ? 'å‚³é€ä¸­...' : (isAppending ? 'é€å‡ºåŠ é»å–®' : 'ç¢ºèªé€å–®') }}
                </button>
            </nav>
        </section>
    </div>

</div>

<script type="module">
    import { createApp, ref, computed, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, push, onValue, serverTimestamp, remove, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyCrXoKUHMvQ8LMr_YuaQYTWEdLfWFYeLYY",
        authDomain: "jiantou-000rlhad.firebaseapp.com",
        databaseURL: "https://jiantou-000rlhad-default-rtdb.firebaseio.com",
        projectId: "jiantou-000rlhad",
        storageBucket: "jiantou-000rlhad.firebasestorage.app",
        messagingSenderId: "435285773521",
        appId: "1:435285773521:web:d6ce66a7d35bf3bbd049f0"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            // ç‹€æ…‹å®šç¾©
            const hasEnteredShop = ref(false);
            const menu = ref([]); 
            const defaultMenu = [{ id: 1, name: 'æ‹›ç‰Œè±¬è‚‰æ²¹é£¯', price: 60, desc: 'å‚³çµ±é¦™è‡è‚‰çµ²', active: true, options: [] }];
            const cart = ref({});
            const selectedItemForOptions = ref(null);
            const selectedOptionsArr = ref([]);
            const myOrder = ref(null);
            const myAddonOrder = ref(null);
            const isSubmitting = ref(false);
            const currentCallingNumber = ref(null);
            const shopIsOpen = ref(true);
            const showDetails = ref(true);
            const isConfirming = ref(false);
            const showPickupModal = ref(false);
            const isTrackingMode = ref(false);
            const trackedNumber = ref(null);
            const tempTrackInput = ref('');
            const trackError = ref('');
            const isTrackedNumberCalled = ref(false);
            const phoneSuffix = ref('');
            const isAppending = ref(false);

            onMounted(() => {
                // å«è™Ÿæ©Ÿè¯å‹•
                onValue(dbRef(db, 'currentCallingNumber'), (snapshot) => { 
                    currentCallingNumber.value = snapshot.val(); 
                });

                // åº—å®¶ç‹€æ…‹è¯å‹•
                onValue(dbRef(db, 'shopStatus'), (snapshot) => {
                    const val = snapshot.val();
                    shopIsOpen.value = (val === null) ? true : val;
                });

                // èœå–®è¯å‹•
                onValue(dbRef(db, 'menu'), (snapshot) => {
                    const data = snapshot.val();
                    menu.value = data ? data.filter(item => item.active) : defaultMenu;
                });

                // æœ¬åœ°è¨‚å–®æ¢å¾©
                const savedOrderKey = localStorage.getItem('jiantou_order_key');
                if (savedOrderKey) {
                    onValue(dbRef(db, `orders/${savedOrderKey}`), (snapshot) => {
                        const data = snapshot.val();
                        if (data && data.status !== 'archived') {
                            myOrder.value = { ...data, key: snapshot.key };
                            hasEnteredShop.value = true;
                        } else {
                            myOrder.value = null;
                            localStorage.removeItem('jiantou_order_key');
                        }
                    });
                }
                
                // æœ¬åœ°åŠ é»è¨‚å–®æ¢å¾©
                const savedAddonKey = localStorage.getItem('jiantou_addon_key');
                if (savedAddonKey) {
                    onValue(dbRef(db, `orders/${savedAddonKey}`), (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            myAddonOrder.value = { ...data, key: snapshot.key };
                        } else {
                            myAddonOrder.value = null;
                            localStorage.removeItem('jiantou_addon_key');
                        }
                    });
                }

                // è¿½è¹¤è™Ÿç¢¼æ¢å¾©
                const savedTrack = localStorage.getItem('jiantou_tracked_number');
                if (savedTrack) {
                    trackedNumber.value = savedTrack; 
                    hasEnteredShop.value = true;
                }
            });

            // é€²å…¥å•†åº—
            const enterShop = () => {
                if (shopIsOpen.value || myOrder.value) {
                    hasEnteredShop.value = true;
                }
            };

            // ç›£è½å–é¤ç‹€æ…‹
            watch(() => myOrder.value?.status, (newStatus, oldStatus) => {
                if (newStatus === 'done' && oldStatus !== 'done') {
                    triggerPickupNotification();
                }
            });

            watch(currentCallingNumber, (newVal) => {
                if (trackedNumber.value && newVal == trackedNumber.value) {
                    isTrackedNumberCalled.value = true;
                    triggerPickupNotification();
                }
            });

            // é€šçŸ¥è§¸ç™¼
            const triggerPickupNotification = () => {
                showPickupModal.value = true;
                const audio = document.getElementById('pickupSound');
                if (audio) {
                    audio.volume = 1.0;
                    audio.play().catch(() => {});
                }
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200, 100, 500]);
                }
            };

            // è³¼ç‰©è»Šé‚è¼¯
            const getItemCount = (id) => {
                return Object.values(cart.value).filter(c => c.item.id === id).reduce((sum, c) => sum + c.qty, 0);
            };

            const addToCart = (item) => {
                if (item.options && item.options.length > 0) {
                    selectedItemForOptions.value = item;
                    selectedOptionsArr.value = [];
                } else {
                    const cartKey = `item_${item.id}`;
                    if (!cart.value[cartKey]) {
                        cart.value[cartKey] = { item: item, options: [], qty: 0 };
                    }
                    cart.value[cartKey].qty++;
                }
            };

            const confirmAddOptions = () => {
                const item = selectedItemForOptions.value;
                const opts = selectedOptionsArr.value;
                const optIds = opts.map(o => o.name).sort().join('_');
                const cartKey = `item_${item.id}_${optIds}`;

                if (!cart.value[cartKey]) {
                    cart.value[cartKey] = { item: item, options: [...opts], qty: 0 };
                }
                cart.value[cartKey].qty++;
                selectedItemForOptions.value = null;
            };

            const removeFromCart = (item) => {
                const keys = Object.keys(cart.value).filter(k => cart.value[k].item.id === item.id);
                if (keys.length > 0) {
                    const lastKey = keys[keys.length - 1];
                    if (cart.value[lastKey].qty > 0) {
                        cart.value[lastKey].qty--;
                        if (cart.value[lastKey].qty === 0) {
                            delete cart.value[lastKey];
                        }
                    }
                }
            };

            const cartCount = computed(() => Object.values(cart.value).reduce((a, b) => a + b.qty, 0));
            const cartTotal = computed(() => {
                let total = 0;
                for (const cartKey in cart.value) {
                    const cItem = cart.value[cartKey];
                    const optPrice = cItem.options.reduce((sum, o) => sum + o.price, 0);
                    total += (cItem.item.price + optPrice) * cItem.qty;
                }
                return total;
            });

            const openConfirmation = () => { if (cartCount.value > 0) isConfirming.value = true; };

            // åŠ é»é‚è¼¯
            const startAppend = () => {
                isAppending.value = true;
                cart.value = {}; 
            };

            const cancelAddon = () => {
                if(confirm('ç¢ºå®šè¦å–æ¶ˆé€™æ¬¡çš„åŠ é»å—ï¼Ÿ')) {
                    if (myAddonOrder.value?.key) {
                        remove(dbRef(db, `orders/${myAddonOrder.value.key}`));
                    }
                    myAddonOrder.value = null;
                    localStorage.removeItem('jiantou_addon_key');
                }
            };

            // é€å–®é‚è¼¯
            const submitOrder = async () => {
                if (!isAppending.value && (!phoneSuffix.value || phoneSuffix.value.length !== 3)) {
                    alert('ç‚ºäº†æ–¹ä¾¿å–é¤ï¼Œè«‹è¼¸å…¥å®Œæ•´çš„æ‰‹æ©Ÿæœ«ä¸‰ç¢¼å–”ï¼');
                    return;
                }

                if (isSubmitting.value) return;
                
                // é è§£é–éŸ³è¨Š
                const audio = document.getElementById('pickupSound');
                if (audio) {
                    audio.volume = 0; 
                    audio.play().then(() => { audio.pause(); audio.currentTime = 0; }).catch(() => {});
                }

                isSubmitting.value = true;
                const newCartItems = [];
                for (const cartKey in cart.value) {
                    const cItem = cart.value[cartKey];
                    newCartItems.push({
                        id: cItem.item.id,
                        name: cItem.item.name,
                        price: cItem.item.price + cItem.options.reduce((s, o) => s + o.price, 0),
                        qty: cItem.qty,
                        options: cItem.options.map(o => o.name)
                    });
                }
                
                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                const dateString = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')}`;

                // è™•ç†åŠ é»
                if (isAppending.value && myOrder.value?.key) {
                    const addonData = {
                        number: myOrder.value.number,
                        parentKey: myOrder.value.key,
                        isAddon: true,
                        items: newCartItems,
                        total: cartTotal.value,
                        status: 'pending',
                        createdAt: serverTimestamp(),
                        timeString: timeString,
                        dateString: dateString
                    };
                    
                    const newRef = push(dbRef(db, 'orders'), addonData);
                    localStorage.setItem('jiantou_addon_key', newRef.key);
                    
                    onValue(dbRef(db, `orders/${newRef.key}`), (snapshot) => {
                        const data = snapshot.val();
                        myAddonOrder.value = data ? { ...data, key: snapshot.key } : null;
                        if (!data) localStorage.removeItem('jiantou_addon_key');
                    });

                    isAppending.value = false;
                    cart.value = {};
                    isConfirming.value = false;
                    isSubmitting.value = false;
                    return; 
                }
                
                // è™•ç†ä¸»è¨‚å–®
                const newOrderData = {
                    number: phoneSuffix.value, 
                    items: newCartItems, 
                    total: cartTotal.value, 
                    status: 'pending',
                    createdAt: serverTimestamp(), 
                    timeString: timeString, 
                    dateString: dateString
                };

                const newRef = push(dbRef(db, 'orders'), newOrderData);
                localStorage.setItem('jiantou_order_key', newRef.key);

                myOrder.value = { ...newOrderData, key: newRef.key };
                cart.value = {};
                isConfirming.value = false;
                isSubmitting.value = false;

                onValue(dbRef(db, `orders/${newRef.key}`), (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.status !== 'archived') {
                        myOrder.value = { ...data, key: snapshot.key };
                    } else {
                        myOrder.value = null;
                        localStorage.removeItem('jiantou_order_key');
                    }
                });
            };

            // é‡ç½®èˆ‡å–æ¶ˆ
            const resetOrder = () => {
                myOrder.value = null;
                trackedNumber.value = null; 
                isTrackedNumberCalled.value = false;
                localStorage.removeItem('jiantou_order_key');
                localStorage.removeItem('jiantou_tracked_number');
            };

            const cancelOrder = () => {
                if(confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†è¨‚å–®å—ï¼Ÿ')) {
                    if (myOrder.value?.key) {
                        remove(dbRef(db, `orders/${myOrder.value.key}`));
                    }
                    resetOrder();
                }
            };

            // å–®è™Ÿè¿½è¹¤
            const startTracking = async () => {
                if (tempTrackInput.value) {
                    trackError.value = '';
                    const inputNum = tempTrackInput.value.toString();
                    const q = query(dbRef(db, 'orders'), orderByChild('number'), equalTo(inputNum));
                    
                    try {
                        const snapshot = await get(q);
                        let isValidOrder = false;
                        if (snapshot.exists()) {
                            snapshot.forEach((child) => {
                                const order = child.val();
                                if (order.status !== 'done' && order.status !== 'archived' && !order.isAddon) {
                                    isValidOrder = true;
                                }
                            });
                        }
                        
                        if (!isValidOrder) {
                            trackError.value = 'ç›®å‰æ²’æœ‰é€™å€‹è™Ÿç¢¼å–”ï¼Œæ˜¯ä¸æ˜¯è¨˜éŒ¯äº†å‘¢';
                            return;
                        }
                        
                        const audio = document.getElementById('pickupSound');
                        if (audio) {
                            audio.volume = 0; 
                            audio.play().then(() => { audio.pause(); audio.currentTime = 0; }).catch(() => {});
                        }

                        trackedNumber.value = inputNum;
                        localStorage.setItem('jiantou_tracked_number', trackedNumber.value);
                        isTrackingMode.value = false;
                        tempTrackInput.value = '';
                        hasEnteredShop.value = true;
                    } catch (error) {
                        trackError.value = 'ç³»çµ±æç¤º: ' + error.message;
                    }
                }
            };

            const stopTracking = () => {
                trackedNumber.value = null;
                isTrackedNumberCalled.value = false;
                localStorage.removeItem('jiantou_tracked_number');
            };

            const closePickupModal = () => { showPickupModal.value = false; };

            const getStatusText = (status) => {
                const map = { pending: 'ç­‰å¾…ä»˜æ¬¾', paid: 'è£½ä½œä¸­', done: 'å¯å–é¤' };
                return map[status] || 'å·²çµæ¡ˆ';
            };

            return { 
                menu, cart, myOrder, isSubmitting, currentCallingNumber,
                getItemCount, addToCart, removeFromCart, cartCount, cartTotal, submitOrder, getStatusText,
                shopIsOpen, showDetails, isConfirming, openConfirmation,
                resetOrder, cancelOrder, showPickupModal, closePickupModal,
                isTrackingMode, tempTrackInput, startTracking, trackedNumber, isTrackedNumberCalled, stopTracking,
                hasEnteredShop, enterShop, trackError,
                selectedItemForOptions, selectedOptionsArr, confirmAddOptions,
                phoneSuffix, isAppending, startAppend, myAddonOrder, cancelAddon
            };
        }
    }).mount('#app');
</script>
</body>
</html>


