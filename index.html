<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‚³çµ±å¤æ—©å‘³ | é»é¤</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDFBF7; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .text-brick { color: #9E5A5A; }
        .bg-brick { background-color: #9E5A5A; }
        .status-paid { background-color: #FDE68A; color: #92400E; }
        .status-done { background-color: #D1FAE5; color: #065F46; }
        [v-cloak] { display: none !important; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } } 
    </style>
</head>
<body class="text-stone-600 h-[100dvh] flex flex-col overflow-hidden select-none">

<div id="app" v-cloak class="h-full flex flex-col relative">
    
    <audio id="pickupSound" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" preload="auto"></audio>

    <div v-if="!hasEnteredShop" class="flex-1 flex flex-col items-center justify-center p-6 bg-[#FDFBF7] relative">
        
        <div class="text-center mb-12 animate-[fadeIn_0.5s_ease-out]">
            <div class="w-24 h-24 bg-stone-800 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl border-4 border-stone-100">
                <span class="material-icons-round text-5xl text-white">restaurant_menu</span>
            </div>
            <h1 class="text-3xl font-bold text-stone-800 tracking-wide serif mb-2">å‚³çµ±å¤æ—©å‘³</h1>
            <p class="text-sm text-brick tracking-[0.3em] font-bold">TRADITIONAL TASTE</p>
            <div class="mt-4">
                <span v-if="shopIsOpen" class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200">â— ç‡Ÿæ¥­ä¸­</span>
                <span v-else class="bg-stone-200 text-stone-500 px-3 py-1 rounded-full text-xs font-bold border border-stone-300">â— ä¼‘æ¯ä¸­</span>
            </div>
        </div>

        <div class="w-full max-w-xs space-y-4 mb-12 animate-[slideUp_0.5s_ease-out]">
            
            <button @click="enterShop" 
                :disabled="!shopIsOpen && !myOrder"
                class="w-full py-5 rounded-2xl font-bold text-xl shadow-lg flex items-center justify-center gap-3 transition-all active:scale-95"
                :class="(!shopIsOpen && !myOrder) ? 'bg-stone-200 text-stone-400 cursor-not-allowed' : 'bg-brick text-white hover:bg-red-900 shadow-red-100'">
                <span class="material-icons-round">{{ myOrder ? 'receipt_long' : 'flatware' }}</span>
                {{ myOrder ? 'æŸ¥çœ‹æˆ‘çš„è¨‚å–®' : (shopIsOpen ? 'é–‹å§‹é»é¤' : 'æœ¬åº—ä¼‘æ¯ä¸­') }}
            </button>

            <button @click="isTrackingMode=true" class="w-full py-5 bg-white border-2 border-stone-100 text-stone-600 rounded-2xl font-bold text-xl shadow-sm flex items-center justify-center gap-3 active:scale-95 transition-transform hover:bg-stone-50 hover:border-stone-200">
                <span class="material-icons-round text-yellow-500">search</span>
                å–®è™Ÿè¿½è¹¤
            </button>

        </div>

        <div class="absolute bottom-10 left-0 right-0 text-center">
            <p class="text-xs text-stone-400 mb-2 tracking-[0.2em] uppercase">Current Call</p>
            <p class="text-5xl font-bold text-stone-300 serif">#{{ currentCallingNumber || '--' }}</p>
        </div>
    </div>


    <div v-else class="flex-1 flex flex-col h-full overflow-hidden animate-[fadeIn_0.3s_ease-out]">
        
        <div class="px-6 pt-8 pb-4 bg-[#FDFBF7] z-10 flex-shrink-0 flex justify-between items-center">
            <div @click="hasEnteredShop=false" class="cursor-pointer"> <h1 class="text-2xl font-bold text-stone-800 tracking-wide serif flex items-center gap-2">
                    <span class="material-icons-round text-stone-400 text-xl">arrow_back_ios</span>
                    å‚³çµ±å¤æ—©å‘³
                </h1> 
                <p class="text-xs text-brick mt-1 tracking-widest pl-6">TRADITIONAL TASTE</p>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-6 pb-40 space-y-4">
            <div v-for="item in menu" :key="item.id" class="flex justify-between items-start bg-white p-4 rounded-xl shadow-sm border border-stone-50">
                <div class="flex-1">
                    <h3 class="text-lg font-medium text-stone-800 serif">{{ item.name }}</h3>
                    <p class="text-xs text-stone-400 mt-1">{{ item.desc }}</p>
                    <span class="text-brick font-bold mt-2 block">${{ item.price }}</span>
                </div>
                <div class="flex items-center gap-3 ml-4">
                    <button v-if="getItemCount(item.id) > 0" @click="removeFromCart(item)" class="w-8 h-8 rounded-full border border-stone-200 text-stone-400 flex items-center justify-center">-</button>
                    <span v-if="getItemCount(item.id) > 0" class="font-medium text-stone-800 w-4 text-center">{{ getItemCount(item.id) }}</span>
                    <button @click="addToCart(item)" class="w-8 h-8 rounded-full bg-brick text-white flex items-center justify-center shadow-md shadow-red-100" :disabled="!shopIsOpen && !myOrder">+</button>
                </div>
            </div>
            <div v-if="!shopIsOpen && !myOrder" class="text-center py-10">
                <p class="text-stone-400 font-bold mb-2">æœ¬åº—ä¼‘æ¯ä¸­</p>
                <p class="text-xs text-stone-300">æš«åœé»é¤ï¼Œåƒ…ä¾›æŸ¥è©¢è¨‚å–®</p>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 z-20 safe-area-bottom">
            
            <div v-if="!myOrder && !trackedNumber" class="bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.05)] rounded-t-3xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <div><p class="text-xs text-stone-400">ç¸½é‡‘é¡</p><p class="text-2xl font-bold text-stone-800">${{ cartTotal }}</p></div>
                    <div class="text-right"><p class="text-xs text-stone-400">å·²é¸å“é …</p><p class="text-sm text-stone-800">{{ cartCount }} ä»½</p></div>
                </div>
                <button @click="openConfirmation" :disabled="cartCount===0" class="w-full py-3.5 rounded-xl font-medium tracking-wide text-white shadow-lg bg-brick disabled:opacity-50 transition-all active:scale-95">æº–å‚™çµå¸³</button>
            </div>

            <div v-else class="bg-white border-t border-brick shadow-[0_-10px_40px_rgba(0,0,0,0.1)] p-6 pb-6 max-h-[60vh] overflow-y-auto">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-xs text-stone-400 uppercase tracking-widest mb-1">YOUR NUMBER</p>
                        <h2 class="text-5xl font-bold text-stone-800 serif">#{{ myOrder?.number || trackedNumber }}</h2>
                    </div>
                    <div class="text-right">
                        <span v-if="trackedNumber" class="px-3 py-1 rounded-full text-xs font-bold" :class="isTrackedNumberCalled ? 'status-done animate-pulse' : 'bg-gray-200 text-gray-600'">{{ isTrackedNumberCalled ? 'å¯å–é¤' : 'ç­‰å¾…å«è™Ÿ' }}</span>
                        <span v-else class="px-3 py-1 rounded-full text-xs font-bold" :class="{'bg-gray-200 text-gray-600': myOrder.status==='pending', 'status-paid': myOrder.status==='paid', 'status-done': myOrder.status==='done'}">{{ getStatusText(myOrder.status) }}</span>
                    </div>
                </div>

                <div v-if="myOrder" class="bg-stone-50 rounded-xl p-4 mb-4 border border-stone-100">
                    <div class="flex justify-between items-center mb-2 cursor-pointer" @click="showDetails = !showDetails"><span class="text-xs font-bold text-stone-500">è¨‚å–®æ˜ç´° ({{ myOrder.items.length }}é …)</span><span class="material-icons-round text-stone-400 text-sm transform transition-transform" :class="showDetails ? 'rotate-180' : ''">expand_more</span></div>
                    <div v-if="showDetails" class="space-y-2 border-t border-stone-200 pt-2 mt-2">
                        <div v-for="(item, index) in myOrder.items" :key="index" class="flex justify-between text-sm text-stone-600"><span>{{ item.name }} x{{ item.qty }}</span><span class="font-medium">${{ item.price * item.qty }}</span></div>
                        <div class="flex justify-between text-base font-bold text-stone-800 pt-2 border-t border-stone-200 mt-2"><span>ç¸½è¨ˆ</span><span>${{ myOrder.total }}</span></div>
                    </div>
                </div>
                
                <div v-if="trackedNumber && !isTrackedNumberCalled" class="text-center p-4 bg-stone-50 rounded-lg text-stone-500 text-sm mb-4">
                    <p>æ­£åœ¨è¿½è¹¤å«è™Ÿæ©Ÿ...</p>
                    <p class="text-xs mt-1">è«‹ä¿æŒç¶²é é–‹å•Ÿï¼Œå«è™Ÿæ™‚æœƒé€šçŸ¥æ‚¨</p>
                </div>

                <div v-if="myOrder?.status === 'pending'" class="text-center p-2 bg-stone-100 rounded-lg text-stone-500 text-sm">
                    è«‹å‘æ«ƒæª¯å‡ºç¤ºæ­¤ç•«é¢ä¸¦ä»˜æ¬¾<br>
                    <button @click="cancelOrder" class="mt-2 text-xs text-stone-400 underline">å–æ¶ˆè¨‚å–® (é‡æ–°é»é¤)</button>
                </div>

                <p v-if="myOrder?.status === 'done' || isTrackedNumberCalled" class="text-center text-sm font-bold text-green-600 mt-4 animate-pulse">ğŸ‰ é¤é»å¥½å›‰ï¼è«‹å–é¤</p>
                
                <button @click="resetOrder" v-if="myOrder?.status==='done' || myOrder?.status==='archived' || isTrackedNumberCalled" class="w-full mt-4 py-2 border border-stone-200 rounded-lg text-sm text-stone-400">é—œé–‰ (ä¸‹ä¸€å–®)</button>
                
                <button @click="stopTracking" v-if="trackedNumber && !isTrackedNumberCalled" class="w-full mt-4 text-xs text-stone-400 underline">åœæ­¢è¿½è¹¤</button>
            </div>
        </div>
    </div>


    <div v-if="showPickupModal" class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-[fadeIn_0.3s_ease-out]">
        <div class="bg-white w-full max-w-sm rounded-2xl p-8 text-center relative shadow-2xl border-4 border-green-400">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-[bounce_1s_infinite]">
                <span class="material-icons-round text-5xl text-green-500">restaurant</span>
            </div>
            <h2 class="text-2xl font-bold text-stone-800 mb-2">é¤é»å¥½å›‰ï¼</h2>
            <p class="text-stone-500 mb-6">å‘¼å«è™Ÿç¢¼</p>
            <div class="text-7xl font-bold text-brick serif mb-8">#{{ myOrder?.number || trackedNumber }}</div>
            <button @click="closePickupModal" class="w-full py-4 bg-stone-800 text-white rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform">
                æˆ‘çŸ¥é“äº†ï¼Œé¦¬ä¸Šå»æ‹¿ï¼
            </button>
        </div>
    </div>

    <div v-if="isTrackingMode" class="fixed inset-0 bg-white z-40 flex flex-col items-center justify-center p-6 animate-[slideUp_0.3s_ease-out]">
        <button @click="isTrackingMode=false" class="absolute top-6 right-6 text-stone-400 p-2"><span class="material-icons-round text-3xl">close</span></button>
        <h2 class="text-2xl font-bold text-stone-800 mb-2 serif">è¼¸å…¥é ˜é¤è™Ÿç¢¼</h2>
        <p class="text-stone-400 text-sm mb-8">æ«ƒå°é»é¤çš„å®¢äººï¼Œè«‹è¼¸å…¥å–®æ“šä¸Šçš„è™Ÿç¢¼</p>
        <input type="number" v-model="tempTrackInput" placeholder="88" 
            class="w-full text-center text-7xl font-bold text-brick border-b-4 border-stone-100 focus:border-brick outline-none py-6 mb-10 bg-transparent serif placeholder-stone-200 h-32">
        <button @click="startTracking" :disabled="!tempTrackInput" class="w-full max-w-xs py-4 bg-brick text-white rounded-xl font-bold text-lg shadow-lg shadow-red-100 disabled:opacity-50 active:scale-95 transition-transform">
            é–‹å§‹è¿½è¹¤
        </button>
    </div>

    <div v-if="isConfirming" class="fixed inset-0 bg-black/60 z-40 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm" @click.self="isConfirming=false">
        <div class="bg-white w-full sm:max-w-sm rounded-t-3xl sm:rounded-2xl p-6 shadow-2xl animate-[slideUp_0.3s_ease-out]">
            <h3 class="text-xl font-bold text-stone-800 mb-4 serif text-center border-b border-stone-100 pb-3">ç¢ºèªé¤é»å…§å®¹</h3>
            <div class="space-y-3 max-h-[50vh] overflow-y-auto mb-4 px-1">
                <div v-for="(qty, id) in cart" :key="id" class="flex justify-between items-center text-sm">
                    <div class="flex flex-col"><span class="font-bold text-stone-700">{{ getMenuName(id) }}</span><span class="text-xs text-stone-400">{{ getMenuDesc(id) }}</span></div>
                    <div class="flex items-center gap-3"><span class="text-stone-500">x{{ qty }}</span><span class="font-medium w-12 text-right">${{ getMenuPrice(id) * qty }}</span></div>
                </div>
            </div>
            <div class="flex justify-between items-center border-t border-dashed border-stone-300 pt-4 mb-6"><span class="text-stone-500 font-bold">ç¸½è¨ˆé‡‘é¡</span><span class="text-3xl font-bold text-brick serif">${{ cartTotal }}</span></div>
            <div class="flex gap-3">
                <button @click="isConfirming=false" class="flex-1 py-3 bg-stone-100 text-stone-500 rounded-xl font-bold">è¿”å›ä¿®æ”¹</button>
                <button @click="submitOrder" :disabled="isSubmitting" class="flex-1 py-3 bg-brick text-white rounded-xl font-bold shadow-lg shadow-red-100 disabled:opacity-50">{{ isSubmitting ? 'å‚³é€ä¸­...' : 'ç¢ºèªé€å–®' }}</button>
            </div>
        </div>
    </div>

</div>

<script type="module">
    import { createApp, ref, computed, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, push, onValue, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCrXoKUHMvQ8LMr_YuaQYTWEdLfWFYeLYY",
        authDomain: "jiantou-000rlhad.firebaseapp.com",
        databaseURL: "https://jiantou-000rlhad-default-rtdb.firebaseio.com",
        projectId: "jiantou-000rlhad",
        storageBucket: "jiantou-000rlhad.firebasestorage.app",
        messagingSenderId: "435285773521",
        appId: "1:435285773521:web:d6ce66a7d35bf3bbd049f0"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            // ğŸŒŸ æ–°å¢ï¼šæ§åˆ¶æ˜¯å¦é€²å…¥å•†åº—
            const hasEnteredShop = ref(false);

            const menu = ref([]); 
            const defaultMenu = [
                { id: 1, name: 'æ‹›ç‰Œè±¬è‚‰æ²¹é£¯', price: 60, desc: 'å‚³çµ±é¦™è‡è‚‰çµ²', active: true },
                { id: 2, name: 'æ¥µå“é´¨è‚‰æ²¹é£¯', price: 80, desc: 'æ¯æ—¥é™é‡', active: true },
                { id: 3, name: 'é¤Šç”Ÿç´ é£Ÿæ²¹é£¯', price: 55, desc: 'å…¨ç´ å¯é£Ÿ', active: true },
                { id: 4, name: 'å¤æ—©å‘³èœé ­ç²¿', price: 45, desc: 'ç…å¾—æ°æ°', active: true },
                { id: 5, name: 'éš¨æ©Ÿå°èœ', price: 30, desc: 'çœ‹è€é—†å¿ƒæƒ…', active: true },
                { id: 6, name: 'å¤æ—©å‘³ç´…èŒ¶', price: 25, desc: 'å†°æ¶¼è§£æ¸´', active: true },
            ];
            const cart = ref({});
            const myOrder = ref(null);
            const isSubmitting = ref(false);
            const currentCallingNumber = ref(null);
            const shopIsOpen = ref(true);
            const showDetails = ref(true);
            const isConfirming = ref(false);
            const showPickupModal = ref(false);
            
            const isTrackingMode = ref(false);
            const trackedNumber = ref(null);
            const tempTrackInput = ref('');
            const isTrackedNumberCalled = ref(false);

            onMounted(() => {
                const callRef = dbRef(db, 'currentCallingNumber');
                onValue(callRef, (snapshot) => { currentCallingNumber.value = snapshot.val(); });

                const shopStatusRef = dbRef(db, 'shopStatus');
                onValue(shopStatusRef, (snapshot) => {
                    const val = snapshot.val();
                    shopIsOpen.value = (val === null) ? true : val;
                });

                const menuRef = dbRef(db, 'menu');
                onValue(menuRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) { menu.value = data.filter(item => item.active); } 
                    else { menu.value = defaultMenu; }
                });

                const savedOrderKey = localStorage.getItem('jiantou_order_key');
                if (savedOrderKey) {
                    const savedOrderRef = dbRef(db, `orders/${savedOrderKey}`);
                    onValue(savedOrderRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data && data.status !== 'archived') {
                            myOrder.value = { ...data, key: snapshot.key };
                            // ğŸŒŸ å¦‚æœå®¢äººæœ¬ä¾†å°±æœ‰è¨‚å–®ï¼Œç›´æ¥è®“ä»–é€²å…¥å•†åº—ï¼Œä¸ç”¨åœåœ¨é¦–é 
                            hasEnteredShop.value = true;
                        } else {
                            myOrder.value = null;
                            localStorage.removeItem('jiantou_order_key');
                        }
                    });
                }

                const savedTrack = localStorage.getItem('jiantou_tracked_number');
                if (savedTrack) {
                    trackedNumber.value = parseInt(savedTrack);
                    // ğŸŒŸ å¦‚æœå®¢äººæ­£åœ¨è¿½è¹¤ï¼Œä¹Ÿç›´æ¥é€²å…¥å•†åº—(é¡¯ç¤ºä¸‹æ–¹ç‹€æ…‹å¡)
                    hasEnteredShop.value = true;
                }
            });

            // ğŸŒŸ é€²å…¥å•†åº— (é–‹å§‹é»é¤æŒ‰éˆ•)
            const enterShop = () => {
                if (shopIsOpen.value || myOrder.value) {
                    hasEnteredShop.value = true;
                }
            };

            watch(() => myOrder.value?.status, (newStatus, oldStatus) => {
                if (newStatus === 'done' && oldStatus !== 'done') {
                    notifyUser();
                }
            });

            watch(currentCallingNumber, (newVal) => {
                if (trackedNumber.value && newVal == trackedNumber.value) {
                    isTrackedNumberCalled.value = true;
                    notifyUser();
                }
            });

            const notifyUser = () => {
                showPickupModal.value = true;
                const audio = document.getElementById('pickupSound');
                if (audio) {
                    audio.volume = 1.0;
                    audio.play().catch(() => {});
                }
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200, 100, 500]);
                }
            };

            const getItemCount = (id) => cart.value[id] || 0;
            const addToCart = (item) => { if (!cart.value[item.id]) cart.value[item.id] = 0; cart.value[item.id]++; };
            const removeFromCart = (item) => { if (cart.value[item.id] > 0) cart.value[item.id]--; if (cart.value[item.id] === 0) delete cart.value[item.id]; };
            const cartCount = computed(() => Object.values(cart.value).reduce((a, b) => a + b, 0));
            const cartTotal = computed(() => {
                let total = 0;
                for (const [id, qty] of Object.entries(cart.value)) {
                    const item = menu.value.find(i => i.id == id);
                    if (item) total += item.price * qty;
                }
                return total;
            });

            const getMenuName = (id) => menu.value.find(i => i.id == id)?.name;
            const getMenuDesc = (id) => menu.value.find(i => i.id == id)?.desc;
            const getMenuPrice = (id) => menu.value.find(i => i.id == id)?.price;
            const openConfirmation = () => { if (cartCount.value > 0) isConfirming.value = true; };

            const submitOrder = () => {
                if (isSubmitting.value) return;
                
                const audio = document.getElementById('pickupSound');
                if (audio) {
                    audio.volume = 0; 
                    audio.play().then(() => { audio.pause(); audio.currentTime = 0; }).catch(() => {});
                }

                isSubmitting.value = true;
                const orderItems = [];
                for (const [id, qty] of Object.entries(cart.value)) {
                    const item = menu.value.find(i => i.id == id);
                    orderItems.push({ ...item, qty });
                }
                const orderNum = Math.floor(Math.random() * 99) + 1;
                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                const dateString = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')}`;

                const newOrderData = {
                    number: orderNum, items: orderItems, total: cartTotal.value, status: 'pending',
                    createdAt: serverTimestamp(), timeString: timeString, dateString: dateString
                };

                const ordersRef = dbRef(db, 'orders');
                const newRef = push(ordersRef, newOrderData);
                const localOrder = { ...newOrderData, key: newRef.key };
                
                localStorage.setItem('jiantou_order_key', newRef.key);

                myOrder.value = localOrder;
                cart.value = {};
                isConfirming.value = false;
                isSubmitting.value = false;

                const thisOrderRef = dbRef(db, `orders/${newRef.key}`);
                onValue(thisOrderRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) myOrder.value = { ...data, key: snapshot.key };
                });
            };

            const resetOrder = () => {
                myOrder.value = null;
                trackedNumber.value = null; 
                isTrackedNumberCalled.value = false;
                localStorage.removeItem('jiantou_order_key');
                localStorage.removeItem('jiantou_tracked_number');
                // ğŸŒŸ è¨‚å–®çµæŸå¾Œï¼Œå¯ä»¥é¸æ“‡å›åˆ°é¦–é  (æˆ–ç•™åœ¨å•†åº—çœ‹èœå–®)
                // é€™è£¡é¸æ“‡ä¸å¼·åˆ¶è¸¢å›é¦–é ï¼Œè®“å®¢äººè‡ªå·±æŒ‰è¿”å›
            };

            const cancelOrder = () => {
                if(confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†è¨‚å–®å—ï¼Ÿ')) {
                    if (myOrder.value && myOrder.value.key) {
                        remove(dbRef(db, `orders/${myOrder.value.key}`));
                    }
                    resetOrder();
                }
            };

            const startTracking = () => {
                if (tempTrackInput.value) {
                    const audio = document.getElementById('pickupSound');
                    if (audio) {
                        audio.volume = 0; 
                        audio.play().then(() => { audio.pause(); audio.currentTime = 0; }).catch(() => {});
                    }

                    trackedNumber.value = parseInt(tempTrackInput.value);
                    localStorage.setItem('jiantou_tracked_number', trackedNumber.value);
                    isTrackingMode.value = false;
                    tempTrackInput.value = '';
                    
                    // ğŸŒŸ è¿½è¹¤æˆåŠŸå¾Œï¼Œç›´æ¥å¸¶å…¥å•†åº—ç•«é¢
                    hasEnteredShop.value = true;
                }
            };

            const stopTracking = () => {
                trackedNumber.value = null;
                isTrackedNumberCalled.value = false;
                localStorage.removeItem('jiantou_tracked_number');
            };

            const stopTrackingAndClear = () => {
                stopTracking();
                tempTrackInput.value = '';
            };
            
            const closePickupModal = () => {
                showPickupModal.value = false;
            };

            const getStatusText = (status) => {
                if (status === 'pending') return 'ç­‰å¾…ä»˜æ¬¾';
                if (status === 'paid') return 'è£½ä½œä¸­';
                if (status === 'done') return 'å¯å–é¤';
                return 'å·²çµæ¡ˆ';
            };

            return { 
                menu, cart, myOrder, isSubmitting, currentCallingNumber,
                getItemCount, addToCart, removeFromCart, cartCount, cartTotal, submitOrder, getStatusText,
                shopIsOpen, showDetails, isConfirming, openConfirmation, getMenuName, getMenuDesc, getMenuPrice,
                resetOrder, cancelOrder, showPickupModal, closePickupModal,
                isTrackingMode, tempTrackInput, startTracking, trackedNumber, isTrackedNumberCalled, stopTracking, stopTrackingAndClear,
                hasEnteredShop, enterShop // ğŸŒŸ
            };
        }
    }).mount('#app');
</script>
</body>
</html>