<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å«è™Ÿé¡¯ç¤ºå±</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .text-brick { color: #9E5A5A; }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .number-pop { animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .list-enter-active, .list-leave-active { transition: all 0.5s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(30px); }
        [v-cloak] { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-stone-900 h-screen overflow-hidden text-stone-400 select-none">

<div id="app" v-cloak class="h-full flex relative">
    
    <audio id="dingSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>

    <button @click="isMuted = !isMuted" class="absolute top-4 left-4 z-50 p-2 rounded-full bg-stone-800/80 text-white hover:bg-stone-700 transition-colors border border-stone-600">
        <span class="material-icons-round text-xl">{{ isMuted ? 'volume_off' : 'volume_up' }}</span>
    </button>

    <div @click="completeCurrent" class="w-[60%] h-full flex flex-col items-center justify-center border-r border-stone-800 relative bg-stone-900 z-10 cursor-pointer active:bg-stone-800 transition-colors group">
        <div class="absolute top-10 text-stone-500 tracking-[0.5em] text-sm uppercase opacity-50">Current Call</div>
        <p class="text-2xl mb-4 font-light tracking-widest text-stone-500">æœ€æ–°å–é¤</p>
        
        <h1 :key="currentNumber" class="text-[15rem] leading-none font-bold serif text-brick number-pop group-hover:scale-105 transition-transform" 
            style="text-shadow: 0 0 50px rgba(158,90,90,0.4);">
            {{ currentNumber || '--' }}
        </h1>
        
        <div class="mt-12">
            <span v-if="currentNumber" class="text-3xl text-stone-200 bg-white/10 px-10 py-4 rounded-full backdrop-blur-md animate-pulse flex items-center gap-3">
                <span class="material-icons-round">touch_app</span> é»æ“Šå®Œæˆå–é¤
            </span>
            <span v-else class="text-2xl text-stone-600 tracking-wider">
                ç¾å‘³æº–å‚™ä¸­...
            </span>
        </div>
    </div>

    <div class="w-[40%] h-full bg-stone-950 flex flex-col min-h-0">
        <div class="p-6 bg-stone-900 border-b border-stone-800 shadow-md z-20 flex-shrink-0">
            <h2 class="text-3xl font-bold text-white tracking-wider flex items-center gap-3">
                <span class="material-icons-round text-brick">restaurant_menu</span> å–é¤å€
            </h2>
            <p class="text-xs text-stone-500 mt-2">é»æ“Šå¡ç‰‡é‡å«</p>
        </div>

        <div class="flex-1 overflow-y-auto p-6 relative no-scrollbar">
            <transition-group name="list" tag="div" class="grid grid-cols-1 gap-4">
                <div v-for="order in recentDoneOrders" :key="order.key" 
                    class="group bg-stone-800/80 border border-stone-700 rounded-xl p-3 flex items-center justify-between hover:bg-stone-800 transition-colors w-full cursor-pointer relative overflow-hidden flex-shrink-0"
                    @click.stop="reCall(order.number)">
                    
                    <div class="flex-1 flex items-center justify-between px-2">
                        <span class="text-5xl font-bold text-stone-200 serif">#{{ order.number }}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-stone-500 bg-stone-900 px-3 py-1 rounded-full border border-stone-800">{{ order.timeString }}</span>
                            <span class="material-icons-round text-stone-500 opacity-20 group-hover:opacity-100 group-hover:text-brick transition-opacity">campaign</span>
                        </div>
                    </div>
                </div>
            </transition-group>
            
            <div v-if="recentDoneOrders.length === 0" class="absolute inset-0 flex items-center justify-center text-stone-600">
                <p>ç›®å‰ç„¡å¾…å–é¤è™Ÿç¢¼</p>
            </div>
            <div class="h-20"></div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 w-[60%] bg-brick/10 py-2 z-20 pointer-events-none">
        <p class="text-stone-500 text-sm text-center animate-pulse">ç¾é»ç¾åšï¼Œè«‹è€å¿ƒç­‰å€™ ğŸ¥£</p>
    </div>

</div>

<script type="module">
    import { createApp, ref, computed, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCrXoKUHMvQ8LMr_YuaQYTWEdLfWFYeLYY",
        authDomain: "jiantou-000rlhad.firebaseapp.com",
        databaseURL: "https://jiantou-000rlhad-default-rtdb.firebaseio.com",
        projectId: "jiantou-000rlhad",
        storageBucket: "jiantou-000rlhad.firebasestorage.app",
        messagingSenderId: "435285773521",
        appId: "1:435285773521:web:d6ce66a7d35bf3bbd049f0"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            const currentNumber = ref(null);
            const doneOrders = ref([]);
            const isMuted = ref(true); // ğŸŒŸ é è¨­éœéŸ³ (é¿å…ç€è¦½å™¨è‡ªå‹•æ’­æ”¾é™åˆ¶)

            onMounted(() => {
                const callRef = dbRef(db, 'currentCallingNumber');
                onValue(callRef, (snapshot) => { currentNumber.value = snapshot.val(); });

                const ordersRef = dbRef(db, 'orders');
                onValue(ordersRef, (snapshot) => {
                    const data = snapshot.val();
                    const list = [];
                    const nowTs = Date.now();
                    const twelveHours = 12 * 60 * 60 * 1000;

                    if (data) {
                        Object.keys(data).forEach(key => {
                            const order = data[key];
                            let isRecent = true;
                            if (order.createdAt) { isRecent = (nowTs - order.createdAt) < twelveHours; }
                            if (order.status === 'done' && isRecent) {
                                list.push({ ...order, key: key });
                            }
                        });
                    }
                    list.sort((a, b) => b.createdAt - a.createdAt);
                    doneOrders.value = list;
                });
            });

            // ğŸŒŸ æ’­æ”¾è²éŸ³é‚è¼¯ï¼šåªæœ‰ç•¶ isMuted ç‚º false æ™‚æ‰å«
            watch(currentNumber, (newVal) => {
                if (newVal && !isMuted.value) {
                    const audio = document.getElementById('dingSound');
                    if(audio) {
                        audio.play().catch(() => {}); // å¿½ç•¥æ’­æ”¾éŒ¯èª¤
                    }
                }
            });

            const recentDoneOrders = computed(() => {
                const filtered = doneOrders.value.filter(o => o.number != currentNumber.value);
                return filtered; 
            });

            const reCall = (number) => { set(dbRef(db, 'currentCallingNumber'), number); };

            // ğŸŒŸ é»æ“Šå¤§ç•«é¢ -> çµæ¡ˆ (å°å­˜è¨‚å–® + æ¸…ç©ºå¤§è¢å¹•)
            const completeCurrent = () => {
                if (!currentNumber.value) return;

                // 1. æ‰¾åˆ°ç•¶å‰é¡¯ç¤ºè™Ÿç¢¼å°æ‡‰çš„è¨‚å–® (å¯èƒ½æœ‰é‡è¤‡è™Ÿç¢¼ï¼Œæ‰¾æœ€æ–°çš„)
                // é€™è£¡ä½¿ç”¨ filter æ‰¾å‡ºæ‰€æœ‰è©²è™Ÿç¢¼çš„è¨‚å–®ï¼Œç„¶å¾ŒæŠŠç‹€æ…‹éƒ½æ”¹æˆ archived
                // é€™æ¨£æ¯”è¼ƒä¿éšªï¼Œä»¥å…åŒä¸€è™Ÿç¢¼æœ‰å…©å¼µå–®ï¼Œçµæœåªæ¶ˆæ‰ä¸€å¼µ
                const targets = doneOrders.value.filter(o => o.number == currentNumber.value);
                
                if (targets.length > 0) {
                    if(confirm(`ç¢ºå®š #${currentNumber.value} å·²å–é¤ï¼Ÿ`)) {
                        targets.forEach(order => {
                            set(dbRef(db, `orders/${order.key}/status`), 'archived');
                        });
                        // 2. æ¸…ç©ºå¤§è¢å¹•é¡¯ç¤º
                        set(dbRef(db, 'currentCallingNumber'), null);
                    }
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°å°æ‡‰è¨‚å–®(å¯èƒ½æ˜¯ç´”å«è™Ÿæ¸¬è©¦)ï¼Œç›´æ¥æ¸…ç©ºè¢å¹•
                    set(dbRef(db, 'currentCallingNumber'), null);
                }
            };

            return { currentNumber, recentDoneOrders, reCall, completeCurrent, isMuted };
        }
    }).mount('#app');
</script>
</body>
</html>