<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å«è™Ÿé¡¯ç¤ºå±</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .text-brick { color: #9E5A5A; }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .number-pop { animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .list-enter-active, .list-leave-active { transition: all 0.5s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(30px); }
    </style>
</head>
<body class="bg-stone-900 h-screen overflow-hidden text-stone-400 select-none">

<div id="app" class="h-full flex">

    <div class="w-[60%] h-full flex flex-col items-center justify-center border-r border-stone-800 relative bg-stone-900 z-10">
        <div class="absolute top-10 text-stone-500 tracking-[0.5em] text-sm uppercase opacity-50">Current Call</div>
        <p class="text-2xl mb-4 font-light tracking-widest text-stone-500">æœ€æ–°å–é¤</p>
        
        <h1 :key="currentNumber" class="text-[15rem] leading-none font-bold serif text-brick number-pop" 
            style="text-shadow: 0 0 50px rgba(158,90,90,0.4);">
            {{ currentNumber || '--' }}
        </h1>
        
        <div class="mt-12">
            <span v-if="currentNumber" class="text-3xl text-stone-200 bg-white/10 px-10 py-4 rounded-full backdrop-blur-md animate-pulse">
                è«‹è‡³æ«ƒå°å–é¤
            </span>
            <span v-else class="text-2xl text-stone-600 tracking-wider">
                ç¾å‘³æº–å‚™ä¸­...
            </span>
        </div>
    </div>

    <div class="w-[40%] h-full bg-stone-950 flex flex-col">
        <div class="p-6 bg-stone-900 border-b border-stone-800 shadow-md z-20">
            <h2 class="text-3xl font-bold text-white tracking-wider flex items-center gap-3">
                <span class="material-icons-round text-brick">restaurant_menu</span> å–é¤å€
            </h2>
            <p class="text-xs text-stone-500 mt-2">é»æ“Šå¡ç‰‡é‡å«ï¼Œé»æ“Šæ‰“å‹¾å®Œæˆ</p>
        </div>

        <div class="flex-1 overflow-hidden p-6 relative">
            <transition-group name="list" tag="div" class="grid grid-cols-1 gap-4">
                <div v-for="order in recentDoneOrders" :key="order.key" 
                    class="group bg-stone-800/80 border border-stone-700 rounded-xl p-3 flex items-center justify-between hover:bg-stone-800 transition-colors w-full cursor-pointer relative overflow-hidden">
                    
                    <div class="flex-1 flex items-center justify-between pr-4" @click="reCall(order.number)">
                        <span class="text-5xl font-bold text-stone-200 serif">#{{ order.number }}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-stone-500 bg-stone-900 px-3 py-1 rounded-full border border-stone-800">{{ order.timeString }}</span>
                            <span class="material-icons-round text-stone-500 opacity-20 group-hover:opacity-100 group-hover:text-brick transition-opacity">campaign</span>
                        </div>
                    </div>

                    <button @click.stop="finishOrder(order)" class="w-12 h-12 rounded-lg bg-stone-700/50 hover:bg-green-600 text-stone-400 hover:text-white flex items-center justify-center transition-colors z-10 border border-stone-600">
                        <span class="material-icons-round text-2xl">check</span>
                    </button>

                </div>
            </transition-group>
            
            <div v-if="recentDoneOrders.length === 0" class="absolute inset-0 flex items-center justify-center text-stone-600">
                <p>ç›®å‰ç„¡å¾…å–é¤è™Ÿç¢¼</p>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 w-[60%] bg-brick/10 py-2 z-20">
        <p class="text-stone-500 text-sm text-center animate-pulse">ç¾é»ç¾åšï¼Œè«‹è€å¿ƒç­‰å€™ ğŸ¥£</p>
    </div>

</div>

<script type="module">
    import { createApp, ref, computed, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCrXoKUHMvQ8LMr_YuaQYTWEdLfWFYeLYY",
        authDomain: "jiantou-000rlhad.firebaseapp.com",
        databaseURL: "https://jiantou-000rlhad-default-rtdb.firebaseio.com",
        projectId: "jiantou-000rlhad",
        storageBucket: "jiantou-000rlhad.firebasestorage.app",
        messagingSenderId: "435285773521",
        appId: "1:435285773521:web:d6ce66a7d35bf3bbd049f0"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            const currentNumber = ref(null);
            const doneOrders = ref([]);

            onMounted(() => {
                const callRef = dbRef(db, 'currentCallingNumber');
                onValue(callRef, (snapshot) => { currentNumber.value = snapshot.val(); });

                const ordersRef = dbRef(db, 'orders');
                onValue(ordersRef, (snapshot) => {
                    const data = snapshot.val();
                    const list = [];
                    const nowTs = Date.now();
                    const twelveHours = 12 * 60 * 60 * 1000;

                    if (data) {
                        Object.keys(data).forEach(key => {
                            const order = data[key];
                            let isRecent = true;
                            if (order.createdAt) { isRecent = (nowTs - order.createdAt) < twelveHours; }
                            if (order.status === 'done' && isRecent) {
                                list.push({ ...order, key: key });
                            }
                        });
                    }
                    list.sort((a, b) => b.createdAt - a.createdAt);
                    doneOrders.value = list;
                });
            });

            const recentDoneOrders = computed(() => {
                const filtered = doneOrders.value.filter(o => o.number != currentNumber.value);
                return filtered.slice(0, 6);
            });

            // ğŸŒŸ é‡æ–°å«è™ŸåŠŸèƒ½
            const reCall = (number) => {
                // æ›´æ–°å¤§è¢å¹•é¡¯ç¤º
                set(dbRef(db, 'currentCallingNumber'), number);
            };

            // ğŸŒŸ å®Œæˆè¨‚å–® (å–é¤å®Œç•¢ï¼Œå¾è³‡æ–™åº«ç§»é™¤)
            const finishOrder = (order) => {
                if(confirm(`ç¢ºå®š #${order.number} å·²å–é¤ï¼Ÿ(å°‡å¾åˆ—è¡¨ç§»é™¤)`)) {
                    // é€™é‚Šä½¿ç”¨ remove æœƒæŠŠè³‡æ–™å®Œå…¨åˆªé™¤ã€‚
                    // å¦‚æœå¦³å¸Œæœ›ä¿ç•™å ±è¡¨ç´€éŒ„ï¼Œä½†ä¸è¦é¡¯ç¤ºåœ¨è¢å¹•ä¸Šï¼Œ
                    // æ‡‰è©²è¦æŠŠç‹€æ…‹æ”¹ç‚º 'archived' è€Œä¸æ˜¯ removeã€‚
                    // ä½†ç‚ºäº†ç¶­æŒç¾åœ¨ç³»çµ±ç°¡å–®ï¼Œæˆ‘å€‘å…ˆç”¨ remove (åˆªé™¤ = çµæ¡ˆ)
                    // âš ï¸ æ³¨æ„ï¼šåˆªé™¤å¾Œï¼Œé€™ç­†å–®å°±ä¸æœƒå‡ºç¾åœ¨å¾Œå°çš„ã€Œä»Šæ—¥ç‡Ÿæ”¶ã€äº†ï¼
                    // remove(dbRef(db, `orders/${order.key}`)); // èˆŠåšæ³• (æœƒåˆªé™¤ç‡Ÿæ”¶)
                    
                    // æ–°åšæ³•ï¼šæ”¹æˆ 'archived' (å°å­˜)
                    set(dbRef(db, `orders/${order.key}/status`), 'archived');
                }
            };

            return { currentNumber, recentDoneOrders, reCall, finishOrder };
        }
    }).mount('#app');
</script>
</body>
</html>