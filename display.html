<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å«è™Ÿé¡¯ç¤ºå±</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .text-brick { color: #9E5A5A; }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .number-pop { animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        /* åˆ—è¡¨é€²å ´å‹•ç•« */
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .list-item { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-stone-900 h-screen overflow-hidden text-stone-400 select-none">

<div id="app" class="h-full flex">

    <div class="w-[60%] h-full flex flex-col items-center justify-center border-r border-stone-800 relative bg-stone-900 z-10">
        <div class="absolute top-10 text-stone-500 tracking-[0.5em] text-sm uppercase opacity-50">Current Call</div>
        <p class="text-2xl mb-4 font-light tracking-widest text-stone-500">æœ€æ–°å–é¤</p>
        
        <h1 :key="currentNumber" class="text-[15rem] leading-none font-bold serif text-brick number-pop" 
            style="text-shadow: 0 0 50px rgba(158,90,90,0.4);">
            {{ currentNumber || '--' }}
        </h1>
        
        <div class="mt-12">
            <span v-if="currentNumber" class="text-3xl text-stone-200 bg-white/10 px-10 py-4 rounded-full backdrop-blur-md animate-pulse">
                è«‹è‡³æ«ƒå°å–é¤
            </span>
            <span v-else class="text-2xl text-stone-600 tracking-wider">
                ç¾å‘³æº–å‚™ä¸­...
            </span>
        </div>
    </div>

    <div class="w-[40%] h-full bg-stone-950 flex flex-col">
        <div class="p-6 bg-stone-900 border-b border-stone-800 shadow-md z-20">
            <h2 class="text-3xl font-bold text-white tracking-wider flex items-center gap-3">
                <span class="material-icons-round text-brick">å·²å«è™Ÿç¢¼</span> å–é¤å€
            </h2>
            <p class="text-sm text-stone-400 mt-2">Ready for Pickup</p>
        </div>

        <div class="flex-1 overflow-y-auto p-6 content-start grid grid-cols-1 gap-4">
            <div v-for="order in recentDoneOrders" :key="order.key" 
                class="list-item bg-stone-800/80 border border-stone-700 rounded-xl p-4 flex items-center justify-between hover:bg-stone-800 transition-colors">
                <span class="text-5xl font-bold text-stone-200 serif">#{{ order.number }}</span>
                <span class="text-xs text-stone-500 bg-stone-900 px-3 py-1 rounded-full border border-stone-800">{{ order.timeString }}</span>
            </div>
            
            <div v-if="recentDoneOrders.length === 0" class="text-center text-stone-600 mt-20">
                <p>ç›®å‰ç„¡å¾…å–é¤è™Ÿç¢¼</p>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 w-[60%] bg-brick/10 py-2 z-20">
        <p class="text-stone-500 text-sm text-center animate-pulse">ç¾é»ç¾åšï¼Œè«‹è€å¿ƒç­‰å€™ ğŸ¥£</p>
    </div>

</div>

<script type="module">
    import { createApp, ref, computed, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCrXoKUHMvQ8LMr_YuaQYTWEdLfWFYeLYY",
        authDomain: "jiantou-000rlhad.firebaseapp.com",
        databaseURL: "https://jiantou-000rlhad-default-rtdb.firebaseio.com",
        projectId: "jiantou-000rlhad",
        storageBucket: "jiantou-000rlhad.firebasestorage.app",
        messagingSenderId: "435285773521",
        appId: "1:435285773521:web:d6ce66a7d35bf3bbd049f0"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            const currentNumber = ref(null);
            const doneOrders = ref([]);

            onMounted(() => {
                // 1. ç›£è½æœ€æ–°å«è™Ÿ (å¤§è¢å¹•)
                const callRef = dbRef(db, 'currentCallingNumber');
                onValue(callRef, (snapshot) => {
                    currentNumber.value = snapshot.val();
                });

                // 2. ç›£è½æ‰€æœ‰è¨‚å–®ï¼ŒæŠ“å‡ºã€Œæœ€è¿‘å·²å®Œæˆã€çš„
                const ordersRef = dbRef(db, 'orders');
                onValue(ordersRef, (snapshot) => {
                    const data = snapshot.val();
                    const list = [];
                    // å–å¾—ç¾åœ¨æ™‚é–“æˆ³ (æ¯«ç§’)
                    const nowTs = Date.now();
                    // 12å°æ™‚çš„æ¯«ç§’æ•¸ (é¿å…é¡¯ç¤ºæ˜¨å¤©çš„èˆŠå–®)
                    const twelveHours = 12 * 60 * 60 * 1000;

                    if (data) {
                        Object.keys(data).forEach(key => {
                            const order = data[key];
                            
                            // åˆ¤æ–·æ¢ä»¶ï¼š
                            // 1. ç‹€æ…‹å¿…é ˆæ˜¯ 'done'
                            // 2. å»ºç«‹æ™‚é–“å¿…é ˆåœ¨éå» 12 å°æ™‚å…§ (é€™æ¨£å°±ä¸ç”¨ç®¡æ—¥æœŸæ ¼å¼å­—ä¸²äº†)
                            // 3. å®¹éŒ¯ï¼šå¦‚æœæ²’æœ‰ createdAt æ¬„ä½ï¼Œå°±æš«æ™‚æ”¾é (ç‚ºäº†ç›¸å®¹èˆŠè³‡æ–™)
                            let isRecent = true;
                            if (order.createdAt) {
                                isRecent = (nowTs - order.createdAt) < twelveHours;
                            }

                            if (order.status === 'done' && isRecent) {
                                list.push({ ...order, key: key });
                            }
                        });
                    }
                    // æ’åºï¼šæœ€æ–°çš„ (createdAt å¤§çš„) æ’åœ¨æœ€å‰é¢
                    list.sort((a, b) => b.createdAt - a.createdAt);
                    
                    doneOrders.value = list;
                });
            });

            // 3. éæ¿¾åˆ—è¡¨ï¼šæŠŠã€Œæ­£åœ¨å¤§è¢å¹•é¡¯ç¤ºã€çš„è™Ÿç¢¼æ‹¿æ‰
            const recentDoneOrders = computed(() => {
                // ç”¨å¯¬é¬†æ¯”å° (==) é¿å…å­—ä¸²è·Ÿæ•¸å­—ä¸ç›¸ç­‰çš„å•é¡Œ
                return doneOrders.value.filter(o => o.number != currentNumber.value);
            });

            return { currentNumber, recentDoneOrders };
        }
    }).mount('#app');
</script>
</body>
</html>