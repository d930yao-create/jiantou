<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>尖頭油飯 | 控單後台</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        body { font-family: sans-serif; background-color: #f5f5f4; }
        .text-brick { color: #9E5A5A; }
        .bg-brick { background-color: #9E5A5A; }
        [v-cloak] { display: none !important; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden text-stone-700 select-none">
<div id="app" v-cloak class="flex-1 flex flex-col h-full relative">
    <div v-if="!isLoggedIn" class="fixed inset-0 bg-stone-100 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-80 text-center">
            <h1 class="text-2xl font-bold text-stone-800 mb-2">後台管理系統</h1>
            <input type="text" v-model="loginUser" placeholder="帳號" class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 mb-3 text-center outline-none focus:border-brick">
            <input type="password" inputmode="numeric" pattern="[0-9]*" v-model="loginPass" placeholder="密碼" class="w-full bg-stone-50 border border-stone-200 rounded-lg p-3 mb-6 text-center outline-none focus:border-brick">
            <button @click="checkLogin" class="w-full bg-stone-800 text-white font-bold py-3 rounded-lg hover:bg-black transition-colors">登入</button>
            <p v-if="loginError" class="text-red-500 text-xs mt-4">帳號或密碼錯誤</p>
        </div>
    </div>

    <div v-else class="flex-1 flex flex-col h-full overflow-hidden">
        <!-- 頂部導覽列 -->
        <div class="bg-white px-4 py-3 border-b flex justify-between items-center shadow-sm z-10 flex-shrink-0">
            <div>
                <button @click="toggleShopStatus" class="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold transition-all" :class="shopIsOpen ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-stone-200 text-stone-500 border border-stone-300'">
                    <span class="material-icons-round text-sm">{{ shopIsOpen ? 'store' : 'storefront' }}</span>
                    {{ shopIsOpen ? '營業中' : '休息中' }}
                </button>
                <div class="flex items-center gap-1 mt-2">
                    <span class="material-icons-round text-stone-400 text-sm">calendar_today</span>
                    <input type="date" v-model="selectedDate" class="text-xs text-stone-600 bg-transparent border-b border-stone-200 outline-none focus:border-brick font-medium">
                </div>
            </div>
            <div class="text-right">
                <p class="text-xs text-stone-400 uppercase">{{ isToday ? '今日營收' : '歷史營收' }}</p>
                <div class="flex items-center gap-2">
                    <p class="text-xl font-bold text-brick">${{ dailyRevenue }}</p>
                    <button @click="showReport=true" class="bg-stone-100 hover:bg-stone-200 rounded-full p-1 transition-colors"><span class="material-icons-round text-sm">poll</span></button>
                </div>
            </div>
        </div>

        <!-- 手機 Tab 切換 -->
        <div class="flex md:hidden bg-stone-100 p-1 gap-1 border-b border-stone-200 flex-shrink-0">
            <button @click="currentTab='pending'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-colors" :class="currentTab==='pending' ? 'bg-white shadow text-stone-800' : 'text-stone-400'">待結帳 ({{ pendingOrders.length }})</button>
            <button @click="currentTab='processing'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-colors" :class="currentTab==='processing' ? 'bg-white shadow text-stone-800' : 'text-stone-400'">製作中 ({{ displayRightColumn.length }})</button>
            <button @click="currentTab='manual'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-colors" :class="currentTab==='manual' ? 'bg-white shadow text-brick' : 'text-stone-400'">現場叫號</button>
        </div>

        <!-- 主內容區 -->
        <div class="flex-1 overflow-hidden relative flex flex-col md:flex-row p-2 gap-2 min-h-0">
            <!-- 待結帳 -->
            <div v-show="currentTab === 'pending' || isDesktop" class="flex-1 bg-white rounded-xl shadow-sm flex flex-col border-t-4 border-gray-400 overflow-hidden min-h-0 md:flex">
                <div class="p-2 bg-gray-100 font-bold text-stone-500 text-sm text-center flex justify-between px-2 flex-shrink-0">
                    <span>待結帳</span><span class="bg-gray-200 px-2 rounded-full text-xs">{{ pendingOrders.length }}</span>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-2">
                    <div v-for="order in pendingOrders" :key="order.key" class="p-3 border rounded-lg bg-white shadow-sm relative group">
                        <button @click.stop="deleteOrder(order)" class="absolute -top-2 -left-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center shadow-md z-10 hover:bg-red-600 transition-colors">
                            <span class="material-icons-round text-sm">close</span>
                        </button>
                        <div @click="updateStatus(order, 'paid')">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs text-stone-400 bg-stone-100 px-1 rounded">{{ order.timeString }}</span>
                                <span class="font-bold text-xl text-stone-800">#{{ order.number }}</span>
                            </div>
                            <div class="flex justify-between items-end border-b border-dashed border-stone-100 pb-2 mb-2">
                                <span class="text-xs text-stone-400">總金額</span>
                                <span class="text-2xl font-bold text-brick">${{ order.total }}</span>
                            </div>
                            <div class="mt-2 space-y-1.5">
                                <div v-for="(item, idx) in order.items" :key="idx" class="flex justify-between items-center bg-stone-50 p-2 rounded-lg border border-stone-100">
                                    <div class="flex flex-col min-w-0 flex-1 pr-2">
                                        <span class="text-sm font-bold text-stone-700 truncate leading-tight">{{ item.name }}</span>
                                        <span v-if="item.options && item.options.length" class="text-[10px] text-brick mt-0.5">{{ item.options.join(', ') }}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-bold text-stone-500 w-6 text-right">x{{ item.qty }}</span>
                                        <button @click.stop="deleteOrderItem(order, idx)" class="w-6 h-6 flex items-center justify-center rounded-md bg-white border border-stone-200 text-stone-300 hover:text-red-400 hover:border-red-200 transition-colors shadow-sm active:scale-95" title="移除此品項">
                                            <span class="material-icons-round text-xs">close</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div v-if="isToday" class="mt-3 text-center text-xs bg-gray-100 text-gray-500 py-2 rounded font-bold hover:bg-stone-200 transition-colors cursor-pointer">點擊收款</div>
                        </div>
                    </div>
                    <div v-if="pendingOrders.length === 0" class="flex items-center justify-center h-full text-xs text-stone-300">無新訂單</div>
                </div>
            </div>

            <!-- 製作中 -->
            <div v-show="currentTab === 'processing' || isDesktop" class="flex-1 bg-white rounded-xl shadow-sm flex flex-col border-t-4 border-brick overflow-hidden min-h-0 md:flex">
                <div class="p-2 bg-red-50 font-bold text-brick text-sm text-center flex justify-between px-2 flex-shrink-0">
                    <span>{{ isToday ? '製作中' : '已完成' }}</span>
                    <span class="bg-red-100 px-2 rounded-full text-xs">{{ displayRightColumn.length }}</span>
                </div>

                <!-- 待製作總覽 -->
                <div v-if="isToday && kitchenStatsArray.length > 0" class="bg-stone-50 border-b border-stone-200 p-2 flex-shrink-0">
                    <div class="text-[10px] text-stone-400 font-bold mb-1 flex items-center gap-1">
                        <span class="material-icons-round text-sm text-orange-500">local_fire_department</span> 待製作總計
                    </div>
                    <div class="flex flex-wrap gap-1.5">
                        <span v-for="stat in kitchenStatsArray" :key="stat.name" 
                              class="px-2 py-0.5 rounded text-xs font-bold shadow-sm"
                              :class="stat.count >= 5 ? 'bg-red-100 text-red-700 border border-red-200' : 'bg-white border border-stone-200 text-stone-600'">
                            {{ stat.name }} <span class="ml-0.5">{{ stat.count }}</span>
                        </span>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-2 space-y-2">
                    <div v-for="order in displayRightColumn" :key="order.key" class="p-3 border border-red-100 bg-red-50/20 rounded-lg shadow-sm relative group transition-colors hover:bg-red-50">
                        <button @click.stop="deleteOrder(order)" class="absolute -top-2 -left-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center shadow-md z-10 hover:bg-red-600 transition-colors">
                            <span class="material-icons-round text-sm">close</span>
                        </button>

                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-stone-400 bg-white/50 px-1 rounded">{{ order.timeString }}</span>
                            <span class="font-bold text-xl text-brick">#{{ order.number }}</span>
                        </div>

                        <div class="mt-2 space-y-1.5">
                            <div v-for="(item, idx) in order.items" :key="idx" class="flex justify-between items-center bg-white/80 p-2 rounded-lg border border-red-100/50">
                                <div class="flex items-center gap-3 flex-1 min-w-0">
                                    <input type="checkbox" :checked="item.ready" @change="toggleItemReady(order, idx)" class="w-5 h-5 accent-green-600 rounded" />
                                    <div class="flex flex-col min-w-0 flex-1" :class="item.ready ? 'line-through text-stone-400' : ''">
                                        <span class="text-sm font-bold text-stone-700 truncate leading-tight">{{ item.name }}</span>
                                        <span v-if="item.options && item.options.length" class="text-[10px] text-brick mt-0.5">{{ item.options.join(', ') }}</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold text-stone-500 w-6 text-right" :class="item.ready ? 'line-through' : ''">x{{ item.qty }}</span>
                                    <button @click.stop="deleteOrderItem(order, idx)" class="w-6 h-6 flex items-center justify-center rounded-md bg-white border border-stone-200 text-stone-300 hover:text-red-400 hover:border-red-200 transition-colors shadow-sm active:scale-95" title="移除此品項">
                                        <span class="material-icons-round text-xs">close</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div v-if="isToday" class="mt-3 flex justify-end">
                            <button 
                                @click="updateStatus(order, 'done')" 
                                :disabled="!allItemsReady(order)"
                                class="text-xs px-4 py-1.5 rounded-full font-bold shadow-sm transition-colors"
                                :class="allItemsReady(order) 
                                    ? 'bg-green-600 text-white hover:bg-green-700' 
                                    : 'bg-stone-300 text-stone-500 cursor-not-allowed'">
                                {{ allItemsReady(order) ? '✓ 全部完成 / 叫號' : '等待完成' }}
                            </button>
                        </div>
                    </div>
                    <div v-if="displayRightColumn.length === 0" class="flex items-center justify-center h-full text-xs text-stone-300">無資料</div>
                </div>
            </div>

            <!-- 現場叫號（略，保持原樣） -->
            <!-- ... 你的 manual 區塊程式碼 ... -->
        </div>

        <!-- 底部導覽 -->
        <div class="bg-white p-2 border-t flex justify-center flex-shrink-0 safe-area-bottom">
            <div class="flex gap-4">
                <button @click="currentTab='menu'" class="text-xs text-stone-400 hover:text-brick flex items-center gap-1 transition-colors">
                    <span class="material-icons-round text-sm">edit_note</span> 菜單管理
                </button>
                <button @click="logout" class="text-xs text-stone-400 underline hover:text-stone-600">登出</button>
            </div>
        </div>
    </div>

    <!-- 菜單管理與報表區塊（保持原樣，略） -->
    <!-- ... 你的 menu 和 showReport 部分 ... -->
</div>

<script type="module">
    import { createApp, ref, computed, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue, update, set, remove, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { /* 你的 config */ };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            // ... 你的原有變數 ...

            onMounted(() => {
                // ... 原有 onMounted 內容 ...

                const ordersRef = dbRef(db, 'orders');
                onValue(ordersRef, (snapshot) => {
                    const data = snapshot.val();
                    allOrders.value = [];
                    if (data) {
                        Object.keys(data).forEach(key => {
                            const orderData = data[key];
                            // 強制為每個 item 補 ready: false
                            if (orderData.items) {
                                orderData.items = orderData.items.map(item => ({
                                    ...item,
                                    ready: item.ready ?? false
                                }));
                            }
                            allOrders.value.push({ ...orderData, key, showDetails: false });
                        });
                    }
                    filterOrdersByDate();
                });
                // ... 其他 onValue ...
            });

            // 檢查訂單是否所有品項都 ready
            const allItemsReady = (order) => {
                if (!order.items || order.items.length === 0) return true;
                return order.items.every(item => item.ready === true);
            };

            // ... 其他原有函數 ...

            return {
                // ... 所有 return 變數 ...
                allItemsReady,
                // ... 其他 ...
            };
        }
    }).mount('#app');
</script>
</body>
</html>
